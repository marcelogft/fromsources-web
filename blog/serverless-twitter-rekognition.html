<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Serverless Twitter Bot + Image Rekognition | From Sources</title>
    <meta name="description" content="Twitter Bot + AWS Rekognition">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900|Material+Icons">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.13/css/all.css">
    
    <link rel="preload" href="/fromsources-web/assets/css/0.styles.08ac24d0.css" as="style"><link rel="preload" href="/fromsources-web/assets/js/app.805b7b41.js" as="script"><link rel="preload" href="/fromsources-web/assets/js/4.8898a6db.js" as="script"><link rel="preload" href="/fromsources-web/assets/js/1.a380d8b6.js" as="script"><link rel="preload" href="/fromsources-web/assets/js/32.2c363502.js" as="script"><link rel="prefetch" href="/fromsources-web/assets/js/10.83b89ba7.js"><link rel="prefetch" href="/fromsources-web/assets/js/11.d56c6a5c.js"><link rel="prefetch" href="/fromsources-web/assets/js/12.bbee6052.js"><link rel="prefetch" href="/fromsources-web/assets/js/13.33ef5605.js"><link rel="prefetch" href="/fromsources-web/assets/js/14.33c59328.js"><link rel="prefetch" href="/fromsources-web/assets/js/15.7c7da050.js"><link rel="prefetch" href="/fromsources-web/assets/js/16.6dbab5ad.js"><link rel="prefetch" href="/fromsources-web/assets/js/17.eb8352a3.js"><link rel="prefetch" href="/fromsources-web/assets/js/18.41214848.js"><link rel="prefetch" href="/fromsources-web/assets/js/19.c38c0dcb.js"><link rel="prefetch" href="/fromsources-web/assets/js/20.483d8f6c.js"><link rel="prefetch" href="/fromsources-web/assets/js/21.ae83da79.js"><link rel="prefetch" href="/fromsources-web/assets/js/22.84259f36.js"><link rel="prefetch" href="/fromsources-web/assets/js/23.282314da.js"><link rel="prefetch" href="/fromsources-web/assets/js/24.9b608495.js"><link rel="prefetch" href="/fromsources-web/assets/js/25.2871ebe2.js"><link rel="prefetch" href="/fromsources-web/assets/js/26.a6c1f0fe.js"><link rel="prefetch" href="/fromsources-web/assets/js/27.5c258e33.js"><link rel="prefetch" href="/fromsources-web/assets/js/28.338ff4b2.js"><link rel="prefetch" href="/fromsources-web/assets/js/29.7374c9f8.js"><link rel="prefetch" href="/fromsources-web/assets/js/30.30499579.js"><link rel="prefetch" href="/fromsources-web/assets/js/31.1b8521d9.js"><link rel="prefetch" href="/fromsources-web/assets/js/33.3a1fb015.js"><link rel="prefetch" href="/fromsources-web/assets/js/5.bb141625.js"><link rel="prefetch" href="/fromsources-web/assets/js/6.12c846f7.js"><link rel="prefetch" href="/fromsources-web/assets/js/7.6db3fbc6.js"><link rel="prefetch" href="/fromsources-web/assets/js/8.85e0043c.js"><link rel="prefetch" href="/fromsources-web/assets/js/9.a60a4127.js"><link rel="prefetch" href="/fromsources-web/assets/js/vendors~docsearch.f92eab53.js">
    <link rel="stylesheet" href="/fromsources-web/assets/css/0.styles.08ac24d0.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/fromsources-web/" class="home-link router-link-active"><!----> <span class="site-name">From Sources</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/fromsources-web/" class="nav-link">Home</a></div><div class="nav-item"><a href="/fromsources-web/blog/" class="nav-link router-link-active">Blog</a></div><div class="nav-item"><a href="/fromsources-web/about/" class="nav-link">About</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/fromsources-web/" class="nav-link">Home</a></div><div class="nav-item"><a href="/fromsources-web/blog/" class="nav-link router-link-active">Blog</a></div><div class="nav-item"><a href="/fromsources-web/about/" class="nav-link">About</a></div> <!----></nav>  <!----> </div> <div class="page"> <div class="content default"><p><img src="http://www.ciobulletin.com/home_image/ciobulletin-amazons-facial-recognition-hits-the-streets-of-orlando.jpg" alt="An image"></p> <h1 id="page-frontmatter-title"><a href="#page-frontmatter-title" aria-hidden="true" class="header-anchor">#</a> Serverless Twitter Bot + Image Rekognition</h1> <p>This is a challenge from <em>#NoServerNovember</em> challenge from the <a href="https://serverless.com/framework/" target="_blank" rel="noopener noreferrer">Serverless Framework<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> team.
The challenge was to make a serverless, image-recognition-backed Twitter bot. When a user tweets at the bot: “@animalbot, what’s in this image?”, the bot should reply with the name image content.</p> <h2 id="summary"><a href="#summary" aria-hidden="true" class="header-anchor">#</a> Summary</h2> <ol><li>Get bot twitter mentions from the last tweet Id processed. Query DynamoDB to get the last Id.</li> <li>Search for 'image?' string</li> <li>Get the first image from the tweet</li> <li>Use AWS Rekognition to get image <em>Labels</em></li> <li>Tweet response with the labels</li> <li>Save the Tweet Id into DynamoDB</li></ol> <h2 id="stack"><a href="#stack" aria-hidden="true" class="header-anchor">#</a> Stack</h2> <br> <img src="https://avatars3.githubusercontent.com/u/13742415?s=400&amp;v=4" width="100" height="100"> <img src="https://www.stratoscale.com/wp-content/uploads/AWS-Lambda.png" width="100" height="100"> <img src="https://pbs.twimg.com/profile_images/1013798240683266048/zRim1x6M.jpg" width="100" height="100"> <img src="https://www.outsystems.com/Forge_CW/_image.aspx/A28atdGCIn2i_ZW11S_0KWgJm3iqRSfV9G8=/amazon-rekognition" width="100" height="100"> <br><br> <ul><li><a href="https://serverless.com/framework/" target="_blank" rel="noopener noreferrer">Serverless Framework<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://aws.amazon.com/lambda/" target="_blank" rel="noopener noreferrer">AWS Lambda<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://developer.twitter.com/en/docs.html" target="_blank" rel="noopener noreferrer">Twitter API<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://aws.amazon.com/es/rekognition/" target="_blank" rel="noopener noreferrer">AWS Rekognition<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <h2 id="twitter-bot"><a href="#twitter-bot" aria-hidden="true" class="header-anchor">#</a> Twitter Bot</h2> <p>Check this article for building a Twitter Bot:
<a href="https://marcelogft.github.io/fromsources-web/blog/serverless-twitter-bot.html" target="_blank" rel="noopener noreferrer">Building a Twitter Bot with Serverless and AWS Lambda<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h2 id="tweeter-mentions"><a href="#tweeter-mentions" aria-hidden="true" class="header-anchor">#</a> Tweeter mentions</h2> <p>The Twitter API provides a mentions endpoint, we can use the <em>since_id</em> parameter to handle and process tweets. Since AWS Lambda is stateless, we can use DynamoDB to store the last Tweet ID processed by the bot.</p> <h3 id="manage-id-with-dynamodb"><a href="#manage-id-with-dynamodb" aria-hidden="true" class="header-anchor">#</a> Manage ID with DynamoDB</h3> <p>Build two functions to get / save the Id.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> options <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// connect to local DB if running offline</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">IS_OFFLINE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  options <span class="token operator">=</span> <span class="token punctuation">{</span>
    region<span class="token punctuation">:</span> <span class="token string">'localhost'</span><span class="token punctuation">,</span>
    endpoint<span class="token punctuation">:</span> <span class="token string">'http://localhost:8000'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AWS<span class="token punctuation">.</span>DynamoDB<span class="token punctuation">.</span>DocumentClient</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">get</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> 
  <span class="token keyword">const</span> params <span class="token operator">=</span> <span class="token punctuation">{</span>
      TableName<span class="token punctuation">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">DYNAMODB_TABLE</span><span class="token punctuation">,</span>
      Key<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        id<span class="token punctuation">:</span> <span class="token string">'last'</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span> 
    <span class="token keyword">return</span> client<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">promise</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">save</span> <span class="token operator">=</span> <span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> params <span class="token operator">=</span> <span class="token punctuation">{</span>
    TableName<span class="token punctuation">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">DYNAMODB_TABLE</span><span class="token punctuation">,</span>
    Item<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      id<span class="token punctuation">:</span> <span class="token string">'last'</span><span class="token punctuation">,</span>
      data<span class="token punctuation">:</span> id
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span> 
  <span class="token comment">// write to the database</span>
  <span class="token keyword">return</span> client<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">promise</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre></div><p>Get the Twitter account mentions, using the <em>since_id</em> parameter, then filter the <em>&quot;image?&quot;</em> text.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> lastId <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>lastId<span class="token punctuation">.</span>Item<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  lastId<span class="token punctuation">.</span>Item <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  lastId<span class="token punctuation">.</span>Item<span class="token punctuation">.</span>data <span class="token operator">=</span> <span class="token string">'1'</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> mentions <span class="token operator">=</span> <span class="token keyword">await</span> tw<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'statuses/mentions_timeline'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>since_id<span class="token punctuation">:</span> lastId<span class="token punctuation">.</span>Item<span class="token punctuation">.</span>data<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>tweets <span class="token operator">=&gt;</span> tweets<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>item <span class="token operator">=&gt;</span> item<span class="token punctuation">.</span>text<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'image?'</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Get Images from the mentions response. The code gets only the first mention, and then gets the first media URL from it. If the mention has more than one image attached, only the first one will be processed.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>mentions <span class="token operator">&amp;&amp;</span> mentions<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> tweet <span class="token operator">=</span> mentions<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
    <span class="token keyword">if</span> <span class="token punctuation">(</span>tweet<span class="token punctuation">.</span>entities<span class="token punctuation">.</span>media<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    
      <span class="token keyword">const</span> imgBytes <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getImageData</span><span class="token punctuation">(</span>tweet<span class="token punctuation">.</span>entities<span class="token punctuation">.</span>media<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>media_url<span class="token punctuation">)</span>
</code></pre></div><p>We need to get the image bytes as we only have the URL from Twitter.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> getImageData <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>url<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">await</span> response<span class="token punctuation">.</span><span class="token function">buffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> data<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="aws-rekognition"><a href="#aws-rekognition" aria-hidden="true" class="header-anchor">#</a> AWS Rekognition</h2> <p>We can call now the AWS Rekognition API to detect the image Labels.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> rekognition <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AWS<span class="token punctuation">.</span>Rekognition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> params <span class="token operator">=</span> <span class="token punctuation">{</span>
  Image<span class="token punctuation">:</span> <span class="token punctuation">{</span>            
    Bytes<span class="token punctuation">:</span> imgBytes
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  MaxLabels<span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
  MinConfidence<span class="token punctuation">:</span> <span class="token number">75</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">await</span> rekognition<span class="token punctuation">.</span><span class="token function">detectLabels</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">promise</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">catch</span><span class="token punctuation">(</span>err <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="tweet-the-response"><a href="#tweet-the-response" aria-hidden="true" class="header-anchor">#</a> Tweet the response</h2> <p>If AWS Rekognition detected labels for the image, we need to build the response, mentioning the requester and replaying the tweet using the incoming Tweet ID. <strong>in_reply_to_status_id</strong> parameter will be needed for that.</p> <p>The last step is to save the processed Tweet Id into DynamoDB.</p> <div class="language-js extra-class"><pre class="language-js"><code> <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>Labels <span class="token operator">&amp;&amp;</span> data<span class="token punctuation">.</span>Labels<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">const</span> tweeted <span class="token operator">=</span> <span class="token keyword">await</span> tw<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'statuses/update'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
         status<span class="token punctuation">:</span> <span class="token string">'@'</span> <span class="token operator">+</span> tweet<span class="token punctuation">.</span>user<span class="token punctuation">.</span>screen_name <span class="token operator">+</span> <span class="token string">&quot; &quot;</span> <span class="token operator">+</span>  <span class="token string">&quot;I can see: &quot;</span> <span class="token operator">+</span> data<span class="token punctuation">.</span>Labels<span class="token punctuation">.</span><span class="token function">map</span> <span class="token punctuation">(</span>label <span class="token operator">=&gt;</span> label<span class="token punctuation">.</span>Name<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">', '</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
         in_reply_to_status_id<span class="token punctuation">:</span> tweet<span class="token punctuation">.</span>id_str<span class="token punctuation">}</span><span class="token punctuation">)</span> 
   <span class="token function">save</span><span class="token punctuation">(</span>tweet<span class="token punctuation">.</span>id_str<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span> 
</code></pre></div><h2 id="serverless-configuration"><a href="#serverless-configuration" aria-hidden="true" class="header-anchor">#</a> Serverless configuration</h2> <p>Function is scheduled to check mentions every 10 minutes.</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">service</span><span class="token punctuation">:</span> serverless<span class="token punctuation">-</span>bot<span class="token punctuation">-</span>rek 
<span class="token key atrule">provider</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> aws  
  <span class="token key atrule">runtime</span><span class="token punctuation">:</span> nodejs8.10 
  <span class="token key atrule">stage</span><span class="token punctuation">:</span> dev
  <span class="token key atrule">region</span><span class="token punctuation">:</span> eu<span class="token punctuation">-</span>west<span class="token punctuation">-</span><span class="token number">1</span>
  <span class="token key atrule">environment</span><span class="token punctuation">:</span>
    <span class="token key atrule">CONSUMER_KEY</span><span class="token punctuation">:</span> TWITTER_CONSUMER_KEY
    <span class="token key atrule">CONSUMER_SECRET</span><span class="token punctuation">:</span> TWITTER_CONSUMER_SECRET
    <span class="token key atrule">ACCESS_TOKEN_KEY</span><span class="token punctuation">:</span> TWITTER_ACCESS_TOKEN_KEY
    <span class="token key atrule">ACCESS_TOKEN_SECRET</span><span class="token punctuation">:</span> TWITTER_ACCESS_TOKEN_SECRET
    <span class="token key atrule">DYNAMODB_TABLE</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>self<span class="token punctuation">:</span>service<span class="token punctuation">}</span><span class="token punctuation">-</span>$<span class="token punctuation">{</span>opt<span class="token punctuation">:</span>stage<span class="token punctuation">,</span> self<span class="token punctuation">:</span>provider.stage<span class="token punctuation">}</span>
  <span class="token key atrule">iamRoleStatements</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">Effect</span><span class="token punctuation">:</span> Allow
      <span class="token key atrule">Action</span><span class="token punctuation">:</span> 
        <span class="token punctuation">-</span> dynamodb<span class="token punctuation">:</span>GetItem
        <span class="token punctuation">-</span> dynamodb<span class="token punctuation">:</span>PutItem 
      <span class="token key atrule">Resource</span><span class="token punctuation">:</span> <span class="token string">&quot;arn:aws:dynamodb:${opt:region, self:provider.region}:*:table/${self:provider.environment.DYNAMODB_TABLE}&quot;</span>
    <span class="token punctuation">-</span> <span class="token key atrule">Effect</span><span class="token punctuation">:</span> Allow
      <span class="token key atrule">Action</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> rekognition<span class="token punctuation">:</span>DetectLabels
      <span class="token key atrule">Resource</span><span class="token punctuation">:</span> <span class="token string">&quot;*&quot;</span>  
<span class="token key atrule">functions</span><span class="token punctuation">:</span>
  <span class="token key atrule">rekbot</span><span class="token punctuation">:</span>
    <span class="token key atrule">handler</span><span class="token punctuation">:</span> handler.rek 
    <span class="token key atrule">events</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">schedule</span><span class="token punctuation">:</span> rate(10 minutes)
<span class="token key atrule">resources</span><span class="token punctuation">:</span>
  <span class="token key atrule">Resources</span><span class="token punctuation">:</span>
    <span class="token key atrule">TodosDynamoDbTable</span><span class="token punctuation">:</span>
      <span class="token key atrule">Type</span><span class="token punctuation">:</span> <span class="token string">'AWS::DynamoDB::Table'</span>
      <span class="token key atrule">DeletionPolicy</span><span class="token punctuation">:</span> Retain
      <span class="token key atrule">Properties</span><span class="token punctuation">:</span>
        <span class="token key atrule">AttributeDefinitions</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span>
            <span class="token key atrule">AttributeName</span><span class="token punctuation">:</span> id
            <span class="token key atrule">AttributeType</span><span class="token punctuation">:</span> S
        <span class="token key atrule">KeySchema</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span>
            <span class="token key atrule">AttributeName</span><span class="token punctuation">:</span> id
            <span class="token key atrule">KeyType</span><span class="token punctuation">:</span> HASH
        <span class="token key atrule">ProvisionedThroughput</span><span class="token punctuation">:</span>
          <span class="token key atrule">ReadCapacityUnits</span><span class="token punctuation">:</span> <span class="token number">1</span>
          <span class="token key atrule">WriteCapacityUnits</span><span class="token punctuation">:</span> <span class="token number">1</span>
        <span class="token key atrule">TableName</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>self<span class="token punctuation">:</span>provider.environment.DYNAMODB_TABLE<span class="token punctuation">}</span>
<span class="token key atrule">plugins</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> serverless<span class="token punctuation">-</span>dynamodb<span class="token punctuation">-</span>local
  <span class="token punctuation">-</span> serverless<span class="token punctuation">-</span>offline
<span class="token key atrule">custom</span><span class="token punctuation">:</span>
  <span class="token key atrule">dynamodb</span><span class="token punctuation">:</span>
    <span class="token key atrule">start</span><span class="token punctuation">:</span>
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8000</span>
      <span class="token key atrule">inMemory</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
      <span class="token key atrule">migrate</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">migration</span><span class="token punctuation">:</span>
      <span class="token key atrule">dir</span><span class="token punctuation">:</span> offline/migrations

</code></pre></div><div class="tip custom-block"><p class="custom-block-title">TIP</p> <p><em>serverless-offline</em> plugin was used to test the function locally using HTTP endpoint to execute manually the function. There are other plugins like <a href="https://www.npmjs.com/package/serverless-local-schedule" target="_blank" rel="noopener noreferrer"><em>serverless-local-schedule</em><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> or <a href="https://www.npmjs.com/package/serverless-offline-scheduler" target="_blank" rel="noopener noreferrer"><em>serverless-offline-scheduler</em><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> to schedule locally.</p></div> <div class="tip custom-block"><p class="custom-block-title">TIP</p> <p><a href="https://www.npmjs.com/package/serverless-dynamodb-local*" target="_blank" rel="noopener noreferrer"><em>serverless-dynamodb-local</em><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> plugin was used to run a local DynamoDB instance.</p></div> <h2 id="result"><a href="#result" aria-hidden="true" class="header-anchor">#</a> Result</h2> <p>If deployment was fine we can tweet the bot:</p> <img src="/fromsources-web/twitter-bot-rek.png" alt="twitter-bot"> <h2 id="sources"><a href="#sources" aria-hidden="true" class="header-anchor">#</a> Sources</h2> <i aria-hidden="true" class="v-icon fab fa-github  theme--light"></i> <p><a href="https://github.com/marcelogft/serverless-twitter-bot-rek" target="_blank" rel="noopener noreferrer">GitHub<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></div> <div class="page-edit"><!----> <!----></div> <!----> <section><div class="layout my-5 column wrap align-center"><div class="flex my-3 xs12 sm4"><div class="text-xs-center"><div><span data-link="#share-facebook"><i aria-hidden="true" class="v-icon fab fa-facebook-square theme--light blue--text text--darken-2" style="font-size:36px;cursor:pointer;"></i></span> <span data-link="#share-linkedin"><i aria-hidden="true" class="v-icon fab fa-linkedin theme--light blue--text text--darken-2" style="font-size:36px;cursor:pointer;"></i></span> <span data-link="#share-twitter"><i aria-hidden="true" class="v-icon fab fa-twitter-square theme--light blue--text text--darken-2" style="font-size:36px;cursor:pointer;"></i></span></div></div></div></div></section> </div> <!----></div><div class="global-ui"><!----></div></div>
    <script src="/fromsources-web/assets/js/app.805b7b41.js" defer></script><script src="/fromsources-web/assets/js/4.8898a6db.js" defer></script><script src="/fromsources-web/assets/js/1.a380d8b6.js" defer></script><script src="/fromsources-web/assets/js/32.2c363502.js" defer></script>
  </body>
</html>
